version: 2.1

orbs:
  android: circleci/android@2.0
  flutter: circleci/flutter@1.0

jobs:
  flutter_tests:
    docker:
      - image: cirrusci/flutter
    steps:
      - checkout
      - run: sudo gem install bundler:2.1.4
      - run: bundle check || sudo bundle install
      - run: bundle exec danger
      - run: flutter doctor
      - run: flutter packages get
      - run: flutter pub run build_runner build --delete-conflicting-outputs
      - run: flutter test --coverage
      - run: bash <(curl -s https://codecov.io/bash)

  flutter_tests_2-10-5:
    docker:
      - image: cirrusci/flutter:2.10.5
    steps:
      - checkout
      - run: sudo gem install bundler:2.1.4
      - run: bundle check || sudo bundle install
      - run: bundle exec danger
      - run: flutter doctor
      - run: flutter packages get
      - run: flutter pub run build_runner build --delete-conflicting-outputs
      - run: flutter test --coverage

  test_android:
    working_directory: ~/project/example/android
    executor:
      name: android/android-machine
      resource-class: xlarge
      tag: 2022.04.1
    steps:
      - checkout:
          path: ~/project
      - flutter/install_sdk_and_pub:
          flutter_version: 2.2.3
          app-dir: ..
      # UI Tests are disabled due to an issue with
      # media projection prompt.
      # - android/start-emulator-and-run-tests:
      #     system-image: system-images;android-30;google_apis;x86
      #     additional-avd-args: -d "Nexus 5"
      #     post-emulator-launch-assemble-command: flutter build apk
      #     test-command: ./gradlew app:connectedAndroidTest
      - android/run-tests:
          test-command: ./gradlew test

  ios_tests:
    macos:
      xcode: "13.4.1"
    working_directory: ~/project/example
    environment:
      FL_OUTPUT_DIR: output
    steps:
      - checkout:
          path: ~/project
      - run:
          name: Install CocoaPods
          command: sudo gem install cocoapods
      - run:
          name: download flutter SDK
          command: if ! test -f "~/flutter_sdk.zip"; then curl -o ~/flutter_sdk.zip https://storage.googleapis.com/flutter_infra_release/releases/stable/macos/flutter_macos_2.2.3-stable.zip; fi
      - run:
          name: unzip flutter SDK
          command: unzip ~/flutter_sdk.zip -d ~
      - run:
          name: export flutter path
          command: echo 'export PATH="$PATH:~/flutter/bin"'  >> $BASH_ENV
      - run: flutter doctor
      - run: flutter pub get
      - run:
          name: Install Pods
          command: cd ios && pod install --repo-update
      - run:
          name: Build and run tests
          command: cd ios && xcodebuild  -allowProvisioningUpdates   -workspace Runner.xcworkspace   -scheme Runner   -sdk iphonesimulator   -destination 'platform=iOS Simulator,name=iPhone 13 Pro Max,OS=15.5'   test | xcpretty

  format_flutter:
    docker:
      - image: cirrusci/flutter
    steps:
      - checkout
      - run: flutter pub get
      - run: flutter pub run build_runner build --delete-conflicting-outputs
      - run:
          name: Check Format
          command: flutter format . --set-exit-if-changed

  lint_flutter:
    docker:
      - image: cirrusci/flutter
    steps:
      - checkout
      - run: flutter pub get
      - run: flutter pub run build_runner build --delete-conflicting-outputs
      - run:
          name: Perform Static Analysis
          command: flutter analyze

  verify_pub:
    docker:
      - image: cirrusci/flutter
    steps:
      - checkout
      - run: flutter pub get
      - run:
          name: Check Package Score
          command: flutter pub run pana --no-warning --exit-code-threshold 0
      - run: flutter pub publish --dry-run

  pub_release:
    docker:
      - image: cirrusci/flutter
    steps:
      - checkout
      - run: chmod +x ./release.sh
      - run: ./release.sh

  gh_ibg_release:
    macos:
      xcode: "13.4.1"
    working_directory: "~"
    steps:
      - checkout:
          path: ~/project
      - run: git clone https://InstabugCI:$RELEASE_GITHUB_TOKEN@github.com/Instabug/Escape.git
      - run: cd Escape && swift build -c release
      - run: cd Escape/.build/release && cp -f Escape /usr/local/bin/escape
      - run: cd project && Escape flutter publish

workflows:
  version: 2
  build-test-and-approval-deploy:
    jobs:
      - flutter_tests
      - flutter_tests_2-10-5
      - test_android
      - ios_tests
      - format_flutter
      - lint_flutter:
          requires:
            - format_flutter
      - verify_pub:
          requires:
            - lint_flutter
      - hold_pub_release:
          type: approval
          requires:
            - flutter_tests
            - flutter_tests_2-10-5
            - test_android
            - ios_tests
            - verify_pub
          filters:
            branches:
              only: master
      - pub_release:
          requires:
            - hold_pub_release
          filters:
            branches:
              only: master
      - hold_gh_ibg_release:
          type: approval
          requires:
            - flutter_tests
            - flutter_tests_2-10-5
            - test_android
            - ios_tests
            - verify_pub
          filters:
            branches:
              only: master
      - gh_ibg_release:
          requires:
            - hold_gh_ibg_release
          filters:
            branches:
              only: master
