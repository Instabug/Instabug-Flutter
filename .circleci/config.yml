version: 2.1

orbs:
  android: circleci/android@2.0
  flutter: circleci/flutter@1.0

jobs:
   danger:
    docker:
      - image: circleci/ruby:2.7.2
    steps:
      - checkout
      - run: bundle install        
      - run: bundle exec danger

   lint_flutter:
    docker:
      - image: cirrusci/flutter
    steps:
      - checkout
      - run: flutter pub get
      - run: flutter format --set-exit-if-changed .
      - run: flutter analyze .
      - run: flutter pub publish --dry-run

   test_flutter:
    parameters:
      version:
        type: string
      codecov:
        type: boolean
    docker:
      - image: cirrusci/flutter:<< parameters.version >>
    steps:
      - checkout
      - run: flutter pub get
      - run: flutter pub run build_runner build --delete-conflicting-outputs
      - run: flutter test --coverage
      - run: if << parameters.codecov >>; then bash <(curl -s https://codecov.io/bash); fi

   test_android:
    working_directory: ~/project/example/android
    executor:
      name: android/android-machine
      resource-class: xlarge
      tag: 2022.04.1
    steps:
      - checkout:
          path: ~/project
      - flutter/install_sdk_and_pub:
          flutter_version: 2.2.3
          app-dir: ..
      # - android/start-emulator-and-run-tests:
      #     system-image: system-images;android-30;google_apis;x86
      #     additional-avd-args: -d "Nexus 5"
      #     post-emulator-launch-assemble-command: flutter build apk
      #     test-command: ./gradlew app:connectedAndroidTest
      - android/run-tests:
          test-command: ./gradlew test
  
   test_ios:
    working_directory: ~/project/example/ios
    macos:
      xcode: 12.5.1
    steps:
      - checkout:
          path: ~/project
      - flutter/install_sdk_and_pub:
          flutter_version: 2.2.3
          app-dir: ..
      - run: pod install --repo-update
      - run: |
            xcodebuild -allowProvisioningUpdates \
                       -workspace Runner.xcworkspace \
                       -scheme Runner \
                       -sdk iphonesimulator \
                       -destination 'name=iPhone 12 Pro Max' \
                       test | xcpretty

   release_pub:
    docker:
      - image: cirrusci/flutter
    steps:
      - checkout
      - run: chmod +x ./release.sh
      - run: ./release.sh

   release_gh_ibg:
    macos:
      xcode: "12.5.1"
    working_directory: "~"
    steps:
      - checkout:
          path: ~/project
      - run: git clone https://InstabugCI:$RELEASE_GITHUB_TOKEN@github.com/Instabug/Escape.git
      - run: cd Escape && swift build -c release
      - run: cd Escape/.build/release && cp -f Escape /usr/local/bin/escape
      - run: cd project && Escape flutter publish
      
workflows:
  version: 2
  build-test-and-approval-deploy:
    jobs:
      - danger
      - lint_flutter
      - test_flutter:
          name: test_flutter-stable
          version: stable
          codecov: true
      - test_flutter:
          name: test_flutter-2.2.3
          version: 2.2.3
          codecov: false
      - test_android
      - test_ios
      - hold_release_pub:
          type: approval
          requires:
            - danger
            - lint_flutter
            - test_flutter-stable
            - test_flutter-2.2.3
            - test_android
            - test_ios
          filters:
            branches:
              only: master
      - release_pub:
          requires:
            - hold_release_pub
          filters:
            branches:
              only: master
      - hold_release_gh_ibg:
          type: approval
          requires:
            - danger
            - lint_flutter
            - test_flutter-stable
            - test_flutter-2.2.3
            - test_android
            - test_ios
          filters:
            branches:
              only: master
      - release_gh_ibg:
          requires:
            - hold_release_gh_ibg
          filters:
            branches:
              only: master
